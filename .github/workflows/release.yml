name: Build and Release

on:
  push:
    branches: [master]
    tags: ['*.*.*', 'v*']
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            platform: linux
            package_type: deb
            artifact_ext: deb
          - os: windows-latest
            platform: windows
            package_type: exe
            artifact_ext: exe
          - os: macos-latest
            platform: macos
            package_type: dmg
            artifact_ext: dmg

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup sbt
        uses: sbt/setup-sbt@v1

      - name: Get version
        id: version
        shell: bash
        run: |
          VERSION=$(git describe --tags --always)
          # Extract clean version for jpackage (must be X.Y.Z format)
          CLEAN_VERSION=$(echo "$VERSION" | grep -oE '^[0-9]+\.[0-9]+\.[0-9]+' || echo "0.7.0")
          # macOS doesn't allow versions starting with 0, transform 0.x.y to x.y.0
          if [[ "$CLEAN_VERSION" =~ ^0\.([0-9]+)\.([0-9]+)$ ]]; then
            MAC_VERSION="${BASH_REMATCH[1]}.${BASH_REMATCH[2]}.0"
          else
            MAC_VERSION="$CLEAN_VERSION"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "clean_version=$CLEAN_VERSION" >> $GITHUB_OUTPUT
          echo "mac_version=$MAC_VERSION" >> $GITHUB_OUTPUT

      - name: Build staged distribution
        run: sbt stage

      - name: Install WiX Toolset (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          dotnet tool install --global wix --version 4.0.5

      - name: Create native package (Linux)
        if: matrix.platform == 'linux'
        shell: bash
        run: |
          # Find the main jar
          MAIN_JAR=$(ls target/universal/stage/lib/avl-editor.avl-editor*.jar | head -1 | xargs basename)

          jpackage \
            --type ${{ matrix.package_type }} \
            --name "avl-editor" \
            --app-version "${{ steps.version.outputs.clean_version }}" \
            --description "AVL Editor - Aircraft aerodynamic analysis tool" \
            --vendor "abajar" \
            --input target/universal/stage/lib \
            --main-jar "$MAIN_JAR" \
            --main-class com.abajar.avleditor.Main \
            --dest output \
            --linux-shortcut \
            --linux-menu-group "Science"

      - name: Create native package (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          # Find the main jar
          $MAIN_JAR = (Get-ChildItem target/universal/stage/lib/avl-editor.avl-editor*.jar | Select-Object -First 1).Name

          jpackage `
            --type ${{ matrix.package_type }} `
            --name "AVL Editor" `
            --app-version "${{ steps.version.outputs.clean_version }}" `
            --description "AVL Editor - Aircraft aerodynamic analysis tool" `
            --vendor "abajar" `
            --input target/universal/stage/lib `
            --main-jar "$MAIN_JAR" `
            --main-class com.abajar.avleditor.Main `
            --dest output `
            --win-shortcut `
            --win-menu `
            --win-menu-group "AVL Editor"

      - name: Create native package (macOS)
        if: matrix.platform == 'macos'
        shell: bash
        run: |
          # Find the main jar
          MAIN_JAR=$(ls target/universal/stage/lib/avl-editor.avl-editor*.jar | head -1 | xargs basename)

          jpackage \
            --type ${{ matrix.package_type }} \
            --name "AVL Editor" \
            --app-version "${{ steps.version.outputs.mac_version }}" \
            --description "AVL Editor - Aircraft aerodynamic analysis tool" \
            --vendor "abajar" \
            --input target/universal/stage/lib \
            --main-jar "$MAIN_JAR" \
            --main-class com.abajar.avleditor.Main \
            --dest output \
            --mac-package-name "AVL Editor"

      - name: Rename artifact
        shell: bash
        run: |
          mkdir -p artifacts
          # Fixed name for latest download links
          cp output/*.${{ matrix.artifact_ext }} artifacts/avl-editor-${{ matrix.platform }}.${{ matrix.artifact_ext }}
          # Versioned name for release history
          mv output/*.${{ matrix.artifact_ext }} artifacts/avl-editor-${{ steps.version.outputs.version }}-${{ matrix.platform }}.${{ matrix.artifact_ext }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: avl-editor-${{ matrix.platform }}
          path: artifacts/*

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/')

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        run: |
          VERSION=$(git describe --tags --always)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: avl-editor ${{ steps.version.outputs.version }}
          files: artifacts/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
